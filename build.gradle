/*
 * This file was generated by the Gradle 'init' task.
 */

plugins {
    id 'java'
    id 'maven-publish'
    id 'com.github.johnrengelman.shadow' version '7.1.2'
}

repositories {
    mavenCentral()
    mavenLocal()
    maven {
        url = 'https://jitpack.io/'
    }
    maven {
        url = 'https://repo.mikeprimm.com/'
    }
    maven {
        url = 'https://repo.onarandombox.com/content/repositories/multiverse/'
    }
    maven {
        url = 'https://repo.codemc.org/repository/maven-public/'
    }
    maven {
        url = 'https://repo.wea-ondara.net/repository/public/'
    }
    maven {
        url = 'https://hub.spigotmc.org/nexus/content/repositories/snapshots/'
    }
    maven {
        url = 'https://oss.sonatype.org/content/repositories/snapshots/'
    }
    // BungeeCord/brigadier のスナップショットは md-5 リポジトリにある場合がある
    maven {
        name = 'md5Snapshots'
        url = uri('https://repo.md-5.net/content/repositories/snapshots/')
    }
    maven {
        url = 'https://repo.extendedclip.com/content/repositories/placeholderapi/'
    }
    // PlaceholderAPI (new official repo)
    maven {
        name = 'helpchatRepoReleases'
        url = uri('https://repo.helpch.at/releases/')
    }
    maven {
        url = 'https://repo.maven.apache.org/maven2/'
    }
    maven {
        url = 'https://maven.enginehub.org/repo/'
    }
}

dependencies {
    implementation 'org.bstats:bstats-bukkit:3.0.0'
    implementation 'org.bstats:bstats-bungeecord:3.0.0'
    implementation 'com.google.code.gson:gson:2.10'
    implementation 'org.apache.commons:commons-lang3:3.12.0'
    implementation 'org.jetbrains:annotations:23.0.0'
    testImplementation 'junit:junit:4.13.2'
    compileOnly 'org.spigotmc:spigot-api:1.16.2-R0.1-SNAPSHOT'
    compileOnly 'net.md-5:bungeecord-api:1.16-R0.2-SNAPSHOT'
    compileOnly 'net.md-5:bungeecord-chat:1.16-R0.3'
    compileOnly 'com.github.MilkBowl:VaultAPI:1.7'
    compileOnly 'org.dynmap:dynmap-api:2.0'
    // Multiverse-Core は v4/v5 ともにリフレクションで対応するため、依存は追加しない
    compileOnly 'com.gmail.nossr50.mcMMO:mcMMO:2.1.154'
    compileOnly 'net.alpenblock:BungeePerms:4.0-dev-114'
    compileOnly 'net.luckperms:api:5.4'
    compileOnly 'me.clip:placeholderapi:2.11.6'
}

group = 'com.github.ucchyocean'
version = '3.1.7'
description = 'A powerfull chat channel plugin with IME (Kana-Kanji conversion) support'

// Java Toolchain を指定（JDKが見つからない環境向け）
java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(8)
    }
}

// 依存解決の調整: 古い BungeeCord API が参照する net.md-5:brigadier スナップショットが
// 取得できない環境があるため、Mojang 公式 brigadier に置換する
configurations.all {
    resolutionStrategy.eachDependency { details ->
        if (details.requested.group == 'net.md-5' && details.requested.name == 'brigadier') {
            details.useTarget 'com.mojang:brigadier:1.0.18'
            details.because 'md-5 brigadier snapshot not available; use Mojang brigadier'
        }
    }
}

shadowJar {
    archiveFileName.set(project.name + "." + archiveExtension.get())

    relocate 'com.google.gson', 'com.github.ucchyocean.lc.lib.com.google.gson'
    relocate 'org.apache.commons.lang3', 'com.github.ucchyocean.lc.lib.org.apache.commons.lang3'
    relocate 'org.jetbrains', 'com.github.ucchyocean.lc.lib.org.jetbrains'
    relocate 'org.bstats', 'com.github.ucchyocean.lc.lib.org.bstats'
}

// デフォルトの build/assemble でもシェード済みJarを作る
tasks.named('assemble') { dependsOn shadowJar }
tasks.named('build') { dependsOn shadowJar }

publishing {
    publications {
        maven(MavenPublication) {
            from(components.java)
        }
    }
}

tasks.withType(JavaCompile) {
    options.encoding = 'UTF-8'
}

processResources {
    def props = [name: project.name, version: project.version, description: project.description]
    inputs.properties props
    filteringCharset 'UTF-8'
    filesMatching('plugin.yml') {
        expand props
    }
}
